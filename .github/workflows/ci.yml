name: CI - Test & Validate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  shellcheck:
    name: ShellCheck - An√°lisis Est√°tico
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Ejecutar ShellCheck en scripts
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning
          check_together: 'yes'

  test-debian:
    name: Test en Debian 12 (Bookworm)
    runs-on: ubuntu-latest
    container:
      image: debian:12

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Instalar dependencias b√°sicas
        run: |
          apt-get update
          apt-get install -y sudo curl git make

      - name: Test instalaci√≥n (dry-run)
        run: |
          cd scripts
          bash setup_terminal.sh --dry-run --yes

      - name: Test instalaci√≥n local
        run: |
          cd scripts
          bash setup_terminal.sh --local --yes

      - name: Verificar instalaci√≥n
        run: |
          cd scripts
          bash verify.sh

  test-ubuntu:
    name: Test en Ubuntu 24.04
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Test instalaci√≥n (dry-run)
        run: |
          cd scripts
          bash setup_terminal.sh --dry-run --yes

      - name: Test instalaci√≥n local
        run: |
          cd scripts
          bash setup_terminal.sh --local --yes

      - name: Verificar instalaci√≥n
        run: |
          cd scripts
          bash verify.sh

  test-system-install:
    name: Test Instalaci√≥n con Sudo
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Test instalaci√≥n de sistema (dry-run)
        run: |
          cd scripts
          sudo bash setup_terminal.sh --system --dry-run --yes

      - name: Test instalaci√≥n de sistema real
        run: |
          cd scripts
          sudo bash setup_terminal.sh --system --yes

      - name: Verificar instalaci√≥n
        run: |
          cd scripts
          bash verify.sh --verbose

      - name: Test que neofetch funciona
        run: neofetch --stdout

      - name: Test que starship funciona
        run: starship --version

      - name: Test desinstalaci√≥n completa
        run: |
          cd scripts
          sudo bash uninstall.sh --remove-config --yes

  test-macos:
    name: Test en macOS (Latest)
    runs-on: macos-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Test instalaci√≥n (dry-run)
        run: |
          cd scripts
          bash setup_terminal.sh --dry-run --yes

      - name: Test instalaci√≥n en macOS
        run: |
          cd scripts
          bash setup_terminal.sh --yes

      - name: Verificar instalaci√≥n
        run: |
          cd scripts
          bash verify.sh --verbose

      - name: Test que neofetch funciona
        run: neofetch --stdout

      - name: Test que starship funciona
        run: starship --version

      - name: Test desinstalaci√≥n
        run: |
          cd scripts
          bash uninstall.sh --yes

  validate-configs:
    name: Validar Configuraciones
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Instalar Starship para validaci√≥n
        run: |
          curl -sS https://starship.rs/install.sh | sh -s -- --yes

      - name: Validar configuraci√≥n de Starship
        run: |
          export STARSHIP_CONFIG=./config/starship.toml
          starship print-config > /dev/null && echo "‚úÖ Configuraci√≥n de Starship v√°lida"

      - name: Verificar sintaxis de Neofetch config
        run: |
          if [ -f config/neofetch.conf ]; then
            bash -n config/neofetch.conf && echo "‚úÖ Sintaxis de Neofetch v√°lida"
          fi

  security-scan:
    name: Escaneo de Seguridad
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Buscar secretos con Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  documentation:
    name: Validar Documentaci√≥n
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Verificar README existe
        run: |
          test -f README.md && echo "‚úÖ README encontrado"

      - name: Verificar CONTRIBUTING existe
        run: |
          test -f CONTRIBUTING.md && echo "‚úÖ CONTRIBUTING encontrado" || echo "‚ö†Ô∏è CONTRIBUTING no encontrado"

      - name: Verificar LICENSE existe
        run: |
          test -f LICENSE && echo "‚úÖ LICENSE encontrado" || echo "‚ö†Ô∏è LICENSE no encontrado"

      - name: Lint Markdown
        uses: actionshub/markdownlint@main
        with:
          path: .
          filesToIgnoreRegex: "node_modules"

  summary:
    name: Resumen de CI
    runs-on: ubuntu-latest
    needs: [shellcheck, test-debian, test-ubuntu, test-system-install, test-macos, validate-configs]
    if: always()

    steps:
      - name: Verificar resultados
        run: |
          echo "üéâ Todos los tests de CI completados"
          echo "Estado: ${{ job.status }}"
